---
layout: post
title: イメチェンつくってました
date: 2014-01-05 17:50:27.000000000 +09:00
categories:
- web-dev
- 日記
tags: []
status: publish
type: post
published: true
meta:
  _title: イメチェンつくってました
  _id: '1409'
  _edit_last: '1'
  _wpcom_is_markdown: '1'
  _thumbnail_id: '1408'
author:
  login: admin
  email: hiroki@hrkd.net
  display_name: admin
  first_name: ''
  last_name: ''
---
<p><img src="/uploads/2014/01/596b596a1782bf4fd375739a921eb1fe-640x486.png" alt="写真の色を美しくする無料色変換サービス「イメチェン」" width="640" height="486" class="alignnone size-medium wp-image-1408" /></p>
<p>13年12月24日にローンチした、<a href="http://www.beatfast.jp">beatfast</a>社の新サービス<br />
<a href="http://www.bf-imech.com/">〜写真の色を美しくする無料色変換サービス〜「イメチェン」</a>の開発に参加させていただきました。</p>
<h2>どんなサービス？</h2>
<blockquote><p>
  あなたのサイトの写真の色はキレイですか？美味しそうですか？スマホだと簡単にアプリでできるのですがPCだとやりかたがわからない…。という人のために作りました。<br />
  CMSが全盛の今ですのでクライアントに紹介するというのに是非！PCからBlogやfacebookに投稿する前にこのサービスをご利用くださーい。
</p></blockquote>
<h2>担当した箇所</h2>
<p>僕が担当したのはサーバーサイド全般と、写真の色変換を行うフィルターの設定値を調整するための、開発者用のwebアプリケーション開発です。<br />
使用したのは</p>
<ul>
<li>PHP</li>
<li>imagemagick</li>
<li>Javascript
<ul>
<li>BackBone.js</li>
<li>jQuery</li>
</ul>
</li>
</ul>
<p>あたりでしょうか。特に難しいことはしていませんが、細かなバグフィックスなど色々勉強になりました。</p>
<h2>サーバーサイド周り</h2>
<p>はPHPで実装していったのですが、今回は開発拠点が札幌で、フロントエンド担当の方とは遠隔でのやりとりしかできませんでしたので、なるべく待ち時間など発生しないように心がけました。</p>
<p>ですのでまずはAPIの設計を行い、jsonの引き渡しフォーマットを最初に確立させ、それぞれがそのフォーマットに従って開発を行うことで、サーバー、フロントどちらも独立して開発を進められる形をとりました。当たり前といえば、当たり前なのですが。</p>
<p>また、今回はレジェンドブラウザへの対応のために、Ajax通信時のjsonでのレスポンスと、同じ値をsmartyテンプレートにアサインして、通常の画面遷移をする2パターンのインターフェイス（？）を準備いたしました。フロント担当の方にはAjaxでリクエストを受け取った際の画面描画全体と、smartyテンプレートファイルのコーディングをしていただきました。</p>
<p>Ajax用とsmarty用と、全く同じロジックでサーバーサイドは実装できるかなと踏んでいたのですが、<br />
実際には、smartyテンプレートファイルに少なからずロジックを持たせない限り、Ajaxとまったく同じ処理は使えないということが度々起こりました。</p>
<p>テンプレートにどこまで役割をもたせるかのバランスが難しいところでした。</p>
<p>例えばAjaxの場合は、APIからの返却で、ステータスコードのようなものを返していて、それをjavascirpt側で受け取ってDOMの再描写する処理をしていたのですが、<br />
smarty側では、ステータスコードを内部で処理して先に描画するテンプレートを指定するような調整をしました。確かにテンプレートには極力ロジックは入れたくない。ただレジェンドブラウザだけのために独自の実装も増やしたくない。。。うーんテンプレートを分岐させるだけのテンプレートを用意するとかがよかったのかな。それも気持ち悪さがありますよね。</p>
<h2>フィルター設定の調整用のアプリケーション</h2>
<p><img src="/uploads/2014/01/Document-640x597.png" alt="Document" width="640" height="597" class="alignnone size-medium wp-image-1416" /></p>
<p>こちらのアプリケーションは、imagemagickの色変換の値をダイナミックに調整、プレビューして、その設定値をブラウザのローカルストレージに保存するというものです。</p>
<p>設定値はサーバーサイドに保存するのがベストですが、かなり早い段階で実装をしたために、サーバー側の実装が追いついていなかったので、ローカルストレージに保存したものをtextareaに書き出し、コピペで共有する形をとりました。（更新頻度が多くなるならば、サーバーに設定を送信するなりが良さそうですね。）</p>
<p>こっちはサクサク実装を終わらせてすごく心地が良かったです。<br />
とにかくBackBone.jsの恩恵を感じまくったアプリケーションでした。</p>
<p>そしてhtml5標準のinput type=rangeはクッソ使いやすいですね。ちょっと前まではjQueryUIで実装するしかなかったのに。（jQueryUIも悪くはなかったですが。）  さらに開発者用なので動作確認ブラウザもchromeオンリーという気楽さ。</p>
<p>html5って、実務で受けられる恩恵って、jsの新しいapiくらいだろって思ってましたが、UIも旧IEが死んでくれれば積極的に使いたいですね。</p>
<h2>ハマったところ</h2>
<h3>自作のダウンロードスクリプトがうまいこと動かなくて我ながらPHPの能力の低さに落ち込む。→ pearライブラリのパワー素晴らしい</h3>
<p>こちらは気分転換してライブラリを使用することで事なきを得ました。</p>
<p>今回は結構pearライブラリを使用して開発がすっごくラクになりました。<br />
やはり大半の処理はライブラリが用意されているのですね。黒い画面が大好きになって、jQuery Pluginを導入すると同じような気軽さで、ここらへんのライブラリにも手が出せるようになってきました。</p>
<h3>imagemagickの挙動の違い → 未だ恒久対応ならず</h3>
<p>実は今も結局原因解明できていないままです。<br />
今回、公開用の環境にはAWSを使用しているのですが、なぜかimagemagickのバージョンは開発サーバーと合っているのに、scaleImageで生成したサムネイルの画質が全く違う、、、</p>
<p>まず、imagemagickのアップデートにも苦労しました。<br />
AWSのyumのリポジトリってデフォルトだとimagemagickのバージョンが低いんですよね。<br />
いいのか悪いのか、恐る恐るサードパーティのリポジトリを追加して、最新バージョンをインストールしようと思いましたが、yum の installでコケる。。。</p>
<p>結局ソースからインストールすることになったのですが、（僕は知識が足りなかったのでスーパーエンジニアが対応。）結局画質は改善できず、とりあえず画像の解像度を上げ（生成するサムネイルのサイズを大きく→imgタグで縮小）逃げました。</p>
<p>imagemagik自体が依存しているソフトウェアに問題があるのかなあ。。。<br />
引き続き原因追っかけ中です。</p>
<h2>ローンチを終えてみて</h2>
<p>感じたのは</p>
<ul>
<li>なるべく早く動くものを形にする</li>
<li>面倒でも、ちょっとの労力で良くなることはしつこくやり続ける</li>
<li>単純な仕組みでも、インターフェイスで楽しくなる</li>
<li>タスク管理システム・チャット・電話・ミーティング、どれにも凝り固まらないようにする</li>
</ul>
<p>ということでしょうか。</p>
<p>早く動くものを作るというのは、モチベーションの維持のためにも大事だなと思いました。<br />
最近初めて参加したハッカソンでの経験もこの気持をより強いものにしていると思います。</p>
<p>また、しつこくやり続けるというのはモチベーションが逆に削がれる作業なのですが、リリース（手元から離れてしまう）する日は決まっているので、それまであがくことは、最終的な満足感やクオリティを大きくしてくれるものではないでしょうか。</p>
<p>今回の「イメチェン」は、言ってしまえばimagemagickで色変換した写真をDLするだけの非常に単純なサービスなのですが、モチーフや、ユーザーとの対話、ユーモアで、魅力的なサービスになっているんじゃないかと思います。僕自身、デザインやイラストは無理だとしても、フロントエンドエンジニアとして積極的に係るべき領域だなと痛感しました。</p>
<p>そして、コミュニケーションを、（ログをしっかり残すべきもの、スピーディーに返答だけもらいたいものなど、）シチュエーションによって使い分けることを意識すると、プロジェクトメンバーの全体把握スピードが早くなる！<br />
あと文面だけの解釈を真に受けすぎずに、ゆとりのある気持ちで開発する！<br />
そうすれば他人の領域にそっぽ向いたりせず、全体を自分事化して、プロジェクト自体を円滑に進めるための精神状態を維持できる！</p>
<h2>最後に</h2>
<p>長々と乱文にお付き合いいただきありがとうございました。<br />
<a href="http://www.bf-imech.com/">〜写真の色を美しくする無料色変換サービス〜「イメチェン」</a>どうぞお試しください。</p>
